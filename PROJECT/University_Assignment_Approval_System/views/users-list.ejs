<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Users List</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --blue:#4b6cb7; --card:#fff; --bg:#f3f5f9; }
    * { box-sizing: border-box; }
    body { font-family: "Segoe UI", sans-serif; margin:0; background:var(--bg); color:#333; }

    .navbar {
      background:var(--blue); color:#fff; padding:10px 20px;
      display:flex; justify-content:space-between; align-items:center;
      gap:12px;
    }
    .navbar a { color:#fff; text-decoration:none; font-weight:600; margin-left:12px; }
    .btn-create { background:var(--blue); color:#fff; padding:8px 12px; border-radius:6px; text-decoration:none; font-weight:700; }

    .container { max-width:1000px; margin:18px auto; background:var(--card); border-radius:10px; padding:18px; box-shadow:0 3px 10px rgba(0,0,0,.08); }

    h1 { text-align:center; margin:6px 0 18px; font-size:22px; }

    .filters { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-bottom:12px; }
    .filters input, .filters select { padding:8px 10px; height:38px; border-radius:6px; border:1px solid #ccc; font-size:13px; min-width:180px; }

    table { width:100%; border-collapse:collapse; margin-top:6px; }
    th, td { padding:10px; border:1px solid #ddd; font-size:14px; text-align:left; }
    th { background:var(--blue); color:#fff; font-weight:700; }
    tr:nth-child(even){ background:#f2f6ff } tr:nth-child(odd){ background:#e6edff }

    .btn { text-decoration:none; padding:6px 10px; border-radius:5px; color:#fff; font-weight:700; font-size:12px; margin-right:6px; display:inline-block; }
    .btn-edit { background:#ffc107; color:#1b1b1b; }
    .btn-delete { background:#dc3545; }

    .pagination { text-align:center; margin-top:12px; }
    .pagination button { padding:6px 10px; margin:0 6px; border:0; border-radius:6px; background:var(--blue); color:#fff; cursor:pointer; font-weight:700; }
    .pagination button:disabled { background:#9aa9d6; cursor:default; }

    /* toast */
    .toast { position:fixed; right:20px; top:20px; z-index:9999; display:none; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,.12); overflow:hidden; }
    .toast .inner { padding:12px 14px; font-weight:600; display:flex; align-items:center; gap:8px; }
    .toast.success { background:#d4edda; color:#155724; }
    .toast.error { background:#f8d7da; color:#721c24; }
    .toast .close { margin-left:8px; cursor:pointer; opacity:.8; font-weight:700; }

    @media (max-width:800px){
      .filters { flex-direction:column; align-items:stretch; }
      .btn-create { width:100%; text-align:center; }
      .navbar { flex-direction:column; align-items:flex-start; gap:8px; }
    }
  </style>
</head>
<body>
  <div class="navbar">
    <div style="font-size:16px; font-weight:700;">Users List</div>
    <div>
      <a href="/admin/dashboard">Dashboard</a>
      <a href="/admin/users/create" class="btn-create">Create User</a>
      <a href="/logout">Logout</a>
    </div>
  </div>

  <div class="container">
    <h1>All Users</h1>

    <!-- toast -->
    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true">
      <div id="toast-inner" class="inner"></div>
    </div>

    <div class="filters">
      <input id="searchInput" type="text" placeholder="Search by name or email" aria-label="Search by name or email">
      <select id="roleFilter" aria-label="Filter by role">
        <option value="">All Roles</option>
        <option>Student</option>
        <option>Professor</option>
        <option>HOD</option>
      </select>

      <select id="deptFilter" aria-label="Filter by department">
        <option value="">All Departments</option>
        <% 
          const deptSet = {};
          users.forEach(u => { if (u.department) deptSet[u.department._id] = u.department.name; });
        %>
        <% Object.keys(deptSet).forEach(k => { %>
          <option value="<%= deptSet[k] %>"><%= deptSet[k] %></option>
        <% }) %>
      </select>
    </div>

    <table id="usersTable">
      <thead>
        <tr><th>Name</th><th>Email</th><th>Role</th><th>Department</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody>
        <% users.forEach(u => { %>
          <tr>
            <td><%= u.name %></td>
            <td><%= u.email %></td>
            <td><%= u.role %></td>
            <td><%= u.department ? u.department.name : '' %></td>
            <td><%= u.status ? u.status : "Active" %></td>
            <td>
              <a href="/admin/users/edit/<%= u._id %>" class="btn btn-edit">Edit</a>
              <a href="/admin/users/delete/<%= u._id %>" class="btn btn-delete" onclick="return confirm('Are you sure you want to delete this user?');">Delete</a>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <div class="pagination" aria-label="Pagination controls">
      <button id="prevBtn">Prev</button>
      <span id="pageInfo">1 / 1</span>
      <button id="nextBtn">Next</button>
    </div>
  </div>

  <script>
    
    (function() {
      const success = <%- JSON.stringify(typeof success !== 'undefined' ? success : null) %>;
      const error   = <%- JSON.stringify(typeof error !== 'undefined' ? error : null) %>;

      const toast = document.getElementById('toast');
      const inner = document.getElementById('toast-inner');

      function showToast(message, isError = false) {
        inner.textContent = (isError ? 'Error: ' : 'Success: ') + message;

        // add close button only once
        if (!inner.querySelector('.close')) {
          const closeBtn = document.createElement('span');
          closeBtn.className = 'close';
          closeBtn.textContent = 'âœ•';
          closeBtn.setAttribute('role', 'button');
          closeBtn.onclick = () => toast.style.display = 'none';
          inner.appendChild(closeBtn);
        }

        toast.className = 'toast ' + (isError ? 'error' : 'success');
        toast.style.display = 'block';

        // auto-hide
        clearTimeout(showToast._hideTimer);
        showToast._hideTimer = setTimeout(() => toast.style.display = 'none', 4000);

        // remove query params that may contain messages (safe fallback)
        try {
          if (history.replaceState) {
            const u = new URL(window.location);
            u.searchParams.delete('success');
            u.searchParams.delete('error');
            history.replaceState(null, '', u.pathname + u.search);
          }
        } catch (e) { error }
      }

      if (success) showToast(success, false);
      if (error) showToast(error, true);
    })();
  </script>

  <script>
    // --- Table filtering and  simple pagination ---
    (function () {
      const rowsPerPage = 5;
      const table = document.getElementById('usersTable');
      const tbody = table.tBodies[0];
      const allRows = Array.from(tbody.rows);

      const searchInput = document.getElementById('searchInput');
      const roleFilter = document.getElementById('roleFilter');
      const deptFilter = document.getElementById('deptFilter');

      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      let visibleRows = allRows.slice(); // rows matching filters
      let currentPage = 1;

      function normalize(s) { return String(s || '').trim().toLowerCase(); }

      function applyFilters() {
        const q = normalize(searchInput.value);
        const role = normalize(roleFilter.value);
        const dept = normalize(deptFilter.value);

        visibleRows = allRows.filter(row => {
          const name = normalize(row.cells[0].textContent);
          const email = normalize(row.cells[1].textContent);
          const r = normalize(row.cells[2].textContent);
          const d = normalize(row.cells[3].textContent);

          const matchesQuery = !q || name.includes(q) || email.includes(q);
          const matchesRole = !role || r === role;
          const matchesDept = !dept || d === dept;
          return matchesQuery && matchesRole && matchesDept;
        });

        currentPage = 1;
        render();
      }

      function render() {
        const totalPages = Math.max(1, Math.ceil(visibleRows.length / rowsPerPage));
        const start = (currentPage - 1) * rowsPerPage;
        const end = start + rowsPerPage;

        // hide all, then show the slice
        allRows.forEach(r => r.style.display = 'none');
        visibleRows.slice(start, end).forEach(r => r.style.display = '');

        pageInfo.textContent = `${currentPage} / ${totalPages}`;
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
      }

      // wire events (debounce search a little)
      let searchTimer = null;
      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(applyFilters, 150);
      });
      roleFilter.addEventListener('change', applyFilters);
      deptFilter.addEventListener('change', applyFilters);

      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) { currentPage--; render(); }
      });
      nextBtn.addEventListener('click', () => {
        const totalPages = Math.max(1, Math.ceil(visibleRows.length / rowsPerPage));
        if (currentPage < totalPages) { currentPage++; render(); }
      });

      // initial render
      applyFilters();
    })();
  </script>
</body>
</html>
